<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vipsy — Status</title>
  <link rel="stylesheet" href="{{ ingress_entry }}/static/style.css">
</head>
<body>
  <div class="container">

    <header>
      <div class="logo">
        <img src="{{ ingress_entry }}/static/logo.png" alt="Vipsy logo" class="logo-img" width="34" height="34">
        <div>
          <h1>Vipsy</h1>
          <p class="subtitle">Home Assistant Secure Gateway</p>
        </div>
      </div>
      <div class="header-right">
        <span class="badge badge--{{ 'green' if caddy_up else 'red' }}" id="run-badge">
          {{ 'Running' if caddy_up else 'Stopped' }}
        </span>
        <span class="pill pill--{{ 'blue' if mode == 'Remote' else 'gray' }}">{{ mode }}</span>
        {% if backend_available %}
        <span class="auth-btn-wrap" id="auth-wrap">
          <span class="pill pill--green" id="auth-email" title="Signed in" {% if not logged_in %}style="display:none"{% endif %}>&#x25cf;</span>
          <a href="{{ ingress_entry }}/logout" class="auth-link" id="auth-logout" {% if not logged_in %}style="display:none"{% endif %}>Sign out</a>
          <a href="#" class="btn btn--sm btn--google" id="auth-login" {% if logged_in %}style="display:none"{% endif %}>
            <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.7C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.5 4.1 29.6 2 24 2 12.9 2 4 10.9 4 22s8.9 20 20 20c11.2 0 19.3-7.9 19.8-18.8.1-.7.2-1.5.2-2.2 0-.7-.1-1.3-.2-2z"/><path fill="#34A853" d="M6.3 14.7l7 5.1C15.2 16 19.2 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.5 4.1 29.6 2 24 2 16 2 9.2 6.7 6.3 14.7z"/><path fill="#FBBC05" d="M24 44c5.2 0 9.9-1.7 13.4-4.6l-6.6-5.4C28.7 35.9 26.5 37 24 37c-6.1 0-10.7-3.1-11.7-8.5l-7 5.4C8.2 41.3 15.5 44 24 44z"/><path fill="#EA4335" d="M44.5 20H24v8.5h11.7c-.8 2.8-2.5 5-4.8 6.6l6.6 5.4C40.5 37.7 44 30.4 44 22c0-.7-.1-1.3-.2-2z"/></svg>
            Sign in
          </a>
        </span>
        {% endif %}
      </div>
    </header>

    {% if auth_error %}
    <div class="card card--setup" id="auth-error-banner" style="border-left:3px solid #dc2626;margin-bottom:1rem">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#dc2626">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>Sign-in failed</strong><br>
        <span class="small muted">{{ auth_error }}</span>
      </div>
    </div>
    {% else %}
    <div class="card card--setup" id="auth-error-banner" style="border-left:3px solid #dc2626;margin-bottom:1rem;display:none">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#dc2626">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>Sign-in failed</strong><br>
        <span class="small muted" id="auth-error-msg"></span>
      </div>
    </div>
    {% endif %}

    {% if tunnel.enabled %}
    <section class="section-title">Secure Tunnel</section>
    <div class="tunnel-card {{ 'tunnel-card--ok' if tunnel.healthy else ('tunnel-card--warn' if tunnel.running else 'tunnel-card--err') }}" id="tunnel-card">
      <div class="tunnel-card__header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/>
        </svg>
        <span>Cloudflare Tunnel</span>
        <span class="access-status {{ 'access-status--ok' if tunnel.healthy else ('access-status--neutral' if tunnel.running else 'access-status--err') }}" id="tunnel-status">
          {% if tunnel.healthy %}✓ Connected{% elif tunnel.running %}⟳ Connecting{% else %}✕ Disconnected{% endif %}
        </span>
      </div>
      <div class="tunnel-card__body">
        <div id="tunnel-quick-url-row" {% if tunnel.mode != 'quick' or not tunnel.url %}style="display:none"{% endif %} class="access-row">
          <span class="access-label">URL</span>
          <a href="{{ tunnel.url or '#' }}" target="_blank" rel="noopener" class="access-link" id="tunnel-url">{{ tunnel.url or '' }}</a>
        </div>
        <div id="tunnel-static-info" {% if tunnel.mode != 'static' or not logged_in %}style="display:none"{% endif %}>
        <div class="access-row">
          <span class="access-label">Hostname</span>
          <span class="access-value mono" id="tunnel-hostname">{{ tunnel.hostname or '\u2014' }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">URL</span>
          <a href="{{ tunnel.url or '#' }}" target="_blank" rel="noopener" class="access-link" id="tunnel-static-url">{{ tunnel.url or '' }}</a>
        </div>
        </div>
        {% if tunnel.fallback_url %}
        <div class="access-row" id="tunnel-fallback-row">
          <span class="access-label">Temp URL <span class="pill pill--gray" style="font-size:.65rem;padding:.1rem .4rem">now</span></span>
          <a href="{{ tunnel.fallback_url }}" target="_blank" rel="noopener" class="access-link" id="tunnel-fallback-url">{{ tunnel.fallback_url }}</a>
        </div>
        {% elif tunnel.mode == 'static' %}
        <div class="access-row" id="tunnel-fallback-row" style="display:none">
          <span class="access-label">Temp URL <span class="pill pill--gray" style="font-size:.65rem;padding:.1rem .4rem">now</span></span>
          <a href="#" target="_blank" rel="noopener" class="access-link" id="tunnel-fallback-url"></a>
        </div>
        {% endif %}
        <div class="access-row">
          <span class="access-label">Unique ID</span>
          <span class="access-value mono" id="tunnel-uid">{{ tunnel.unique_id or '—' }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">Provider</span>
          <span class="access-value">Cloudflare {{ '(Static)' if tunnel.mode == 'static' else '(Quick — URL resets on restart)' }}</span>
        </div>
        {% if tunnel.error %}
        <div class="tunnel-error">
          <svg width="15" height="15" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;margin-top:.1rem">
            <path d="M10 2L2 17h16L10 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M10 8v4M10 14v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>{{ tunnel.error }}</span>
        </div>
        {% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--ok" id="tunnel-hint-ok" {% if not tunnel.healthy %}style="display:none"{% endif %}>
        Accessible from anywhere — no port forwarding required.{% if tunnel.mode == 'quick' %}<br><span class="small muted">Quick Tunnel URL changes on add-on restart.</span>{% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--warn" id="tunnel-hint-warn" {% if tunnel.healthy or not tunnel.running %}style="display:none"{% endif %}>
        Tunnel is connecting. This usually takes a few seconds.{% if tunnel.fallback_url %} Use the <strong>Temp URL</strong> above in the meantime.{% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--err" id="tunnel-hint-err" {% if tunnel.healthy or tunnel.running %}style="display:none"{% endif %}>
        Tunnel is not running. Check the add-on logs.{% if tunnel.fallback_url %} Use the <strong>Temp URL</strong> above in the meantime.{% endif %}
      </div>
    </div>
    {% endif %}

    <section class="section-title">Access</section>
    <div class="access-grid">

      <div class="access-card {{ 'access-card--ok' if access.local.reachable else 'access-card--warn' }}">
        <div class="access-card__header">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Local Network</span>
          <span class="access-status {{ 'access-status--ok' if access.local.reachable else 'access-status--err' }}" id="local-status">
            {{ '✓ Reachable' if access.local.reachable else '✕ Not Reachable' }}
          </span>
        </div>
        <div class="access-card__body">
          <div class="access-row">
            <span class="access-label">LAN IP</span>
            <span class="access-value mono" id="local-ip">{{ access.local.ip or '—' }}</span>
          </div>
          <div class="access-row">
            <span class="access-label">Port</span>
            <span class="access-value mono">{{ access.local.port }} (HTTPS)</span>
          </div>
          {% if access.local.url %}
          <div class="access-row">
            <span class="access-label">URL</span>
            <a href="{{ access.local.url }}" target="_blank" rel="noopener" class="access-link" id="local-url">{{ access.local.url }}</a>
          </div>
          {% endif %}
        </div>
        {% if not access.local.reachable %}
        <div class="access-card__hint">
          Port {{ access.local.port }} is not responding. Check that Caddy is running. Use <strong>https://</strong> (not http).
        </div>
        {% else %}
        <div class="access-card__hint access-card__hint--info">
          Use <strong>https://</strong> — plain http will show &ldquo;Bad Request&rdquo;. Self-signed cert: click <em>Advanced → Proceed</em>.
        </div>
        {% endif %}
      </div>

      <div class="access-card {{ 'access-card--ok' if access.external.reachable else ('access-card--warn' if access.external.configured else 'access-card--info') }}">
        <div class="access-card__header">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>Remote Access</span>
          {% if not access.external.configured %}
          <span class="access-status access-status--neutral">No Public IP</span>
          {% elif access.external.reachable %}
          <span class="access-status access-status--ok" id="ext-status">✓ Reachable</span>
          {% else %}
          <span class="access-status access-status--err" id="ext-status">✕ Not Reachable</span>
          {% endif %}
        </div>
        <div class="access-card__body">
          {% if access.external.mode == 'domain' %}
          <div class="access-row">
            <span class="access-label">Domain</span>
            <span class="access-value mono" id="ext-domain">{{ access.external.domain }}</span>
          </div>
          {% endif %}
          <div class="access-row">
            <span class="access-label">Public IP</span>
            <span class="access-value mono" id="ext-ip">{{ access.external.public_ip or 'Detecting…' }}</span>
          </div>
          <div class="access-row">
            <span class="access-label">Port</span>
            <span class="access-value mono">{{ access.external.port }} (HTTPS)</span>
          </div>
          {% if access.external.url %}
          <div class="access-row">
            <span class="access-label">URL</span>
            <a href="{{ access.external.url }}" target="_blank" rel="noopener" class="access-link" id="ext-url">{{ access.external.url }}</a>
          </div>
          {% endif %}
        </div>
        {% if not access.external.configured %}
        <div class="access-card__hint">
          Could not determine public IP. Check internet connectivity.
        </div>
        {% elif access.external.mode == 'ip' and not access.external.reachable %}
        <div class="access-card__hint">
          Port <strong>{{ access.external.port }}</strong> is not yet forwarded on your router.<br>
          <strong>One-time setup:</strong> In your router admin, create a port-forward rule:<br>
          &nbsp;&nbsp;External port <strong>{{ access.external.port }}</strong> TCP &rarr; internal <strong>{{ access.local.ip or '(see LAN IP)' }}:{{ access.external.port }}</strong><br>
          Then use <strong>https://{{ access.external.public_ip }}:{{ access.external.port }}</strong> from anywhere.<br>
          Self-signed cert &mdash; click <em>Advanced &rarr; Proceed</em> on first visit.
        </div>
        {% elif access.external.mode == 'ip' and access.external.reachable %}
        <div class="access-card__hint access-card__hint--info">
          Self-signed certificate. On first visit click <em>Advanced &rarr; Proceed</em> in your browser.
        </div>
        {% elif access.external.mode == 'domain' and not access.external.reachable %}
        <div class="access-card__hint">
          Port {{ access.external.port }} on your domain is not serving Vipsy. Check router port-forwarding and DNS.
        </div>
        {% endif %}
      </div>

    </div>

    <section class="section-title">Home Assistant Core</section>
    <div class="card stat-row">
      <span class="stat-label">HA Core (:8123)</span>
      <span class="{{ 'chip chip--green' if access.ha_core.reachable else 'chip chip--red' }}" id="ha-status">
        <span class="dot dot--{{ 'green' if access.ha_core.reachable else 'red' }}"></span>
        {{ 'Reachable' if access.ha_core.reachable else 'Not Reachable' }}
      </span>
    </div>
    {% if access.ha_core.reachable and not access.ha_core.proxy_ok %}
    <div class="card card--setup">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#b45309">
        <path d="M10 2L2 17h16L10 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M10 8v4M10 14v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>One-time HA setup needed</strong><br>
        <span class="small muted">Add this to your <code>configuration.yaml</code> then restart HA Core:</span>
        <pre class="setup-code">http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24
    - 127.0.0.1</pre>
      </div>
    </div>
    {% endif %}

    <section class="section-title">Services</section>
    <div class="card">
      <table>
        <thead>
          <tr><th>Service</th><th>Status</th><th>Role</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Caddy</td>
            <td><span class="dot dot--{{ 'green' if caddy_up else 'red' }}"></span>{{ 'Up' if caddy_up else 'Down' }}</td>
            <td class="muted">TLS termination + reverse proxy</td>
          </tr>
          {% if enable_turn %}
          <tr>
            <td>coturn</td>
            <td><span class="dot dot--{{ 'green' if turn_up else 'red' }}"></span>{{ 'Up' if turn_up else 'Down' }}</td>
            <td class="muted">TURN/STUN relay (WebRTC)</td>
          </tr>
          {% endif %}
          {% if tunnel.enabled %}
          <tr>
            <td>cloudflared</td>
            <td><span class="dot dot--{{ 'green' if tunnel.running else 'red' }}"></span>{{ 'Up' if tunnel.running else 'Down' }}</td>
            <td class="muted">Cloudflare Tunnel connector</td>
          </tr>
          {% endif %}
          <tr>
            <td>TLS Certificate</td>
            <td colspan="2" class="mono small">{{ cert_status }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <section class="card card--notice">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="flex-shrink:0">
        <circle cx="10" cy="10" r="9" stroke="#6b7280" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <p>This add-on does <strong>not</strong> expose your LAN, provide SSH access, or function as a VPN. Only Home Assistant is accessible.</p>
    </section>

    <footer>
      <span>Vipsy v{{ version }}</span>
      <span id="last-refresh">{{ now }}</span>
    </footer>

  </div>
  <script>
    var INGRESS_ENTRY = "{{ ingress_entry }}";
    var BACKEND_AVAILABLE = {{ 'true' if backend_available else 'false' }};
    var LOGGED_IN = {{ 'true' if logged_in else 'false' }};
    var BACKEND_URL = "{{ backend_url }}";
    var INSTANCE_ID = "{{ instance_id }}";
  </script>
  <script src="{{ ingress_entry }}/static/app.js"></script>
</body>
</html>
