<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vipsy — Status</title>
  <link rel="stylesheet" href="{{ ingress_entry }}/static/style.css?v={{ version }}">
</head>
<body>
  <div class="container">

    <header>
      <div class="logo">
        <img src="{{ ingress_entry }}/static/logo.png" alt="Vipsy logo" class="logo-img" width="34" height="34">
        <div>
          <h1>Vipsy</h1>
          <p class="subtitle">Home Assistant Secure Gateway</p>
        </div>
      </div>
      <div class="header-right">
        <span class="badge badge--{{ 'green' if caddy_up else 'red' }}" id="run-badge">
          {{ 'Running' if caddy_up else 'Stopped' }}
        </span>
        <span class="pill pill--{{ 'blue' if mode == 'Remote' else 'gray' }}">{{ mode }}</span>
        {% if backend_available %}
        <span class="auth-btn-wrap" id="auth-wrap">
          <span class="pill pill--green" id="auth-email" title="Signed in" {% if not logged_in %}style="display:none"{% endif %}>&#x25cf;</span>
          <a href="{{ ingress_entry }}/logout" class="auth-link" id="auth-logout" {% if not logged_in %}style="display:none"{% endif %}>Sign out</a>
          <a href="#" class="btn btn--sm btn--google" id="auth-login" {% if logged_in %}style="display:none"{% endif %}>
            <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.7C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.5 4.1 29.6 2 24 2 12.9 2 4 10.9 4 22s8.9 20 20 20c11.2 0 19.3-7.9 19.8-18.8.1-.7.2-1.5.2-2.2 0-.7-.1-1.3-.2-2z"/><path fill="#34A853" d="M6.3 14.7l7 5.1C15.2 16 19.2 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.5 4.1 29.6 2 24 2 16 2 9.2 6.7 6.3 14.7z"/><path fill="#FBBC05" d="M24 44c5.2 0 9.9-1.7 13.4-4.6l-6.6-5.4C28.7 35.9 26.5 37 24 37c-6.1 0-10.7-3.1-11.7-8.5l-7 5.4C8.2 41.3 15.5 44 24 44z"/><path fill="#EA4335" d="M44.5 20H24v8.5h11.7c-.8 2.8-2.5 5-4.8 6.6l6.6 5.4C40.5 37.7 44 30.4 44 22c0-.7-.1-1.3-.2-2z"/></svg>
            Sign in
          </a>
        </span>
        {% endif %}
      </div>
    </header>

    {% if auth_error %}
    <div class="card card--setup" id="auth-error-banner" style="border-left:3px solid #dc2626;margin-bottom:1rem">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#dc2626">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>Sign-in failed</strong><br>
        <span class="small muted">{{ auth_error }}</span>
      </div>
    </div>
    {% else %}
    <div class="card card--setup" id="auth-error-banner" style="border-left:3px solid #dc2626;margin-bottom:1rem;display:none">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#dc2626">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>Sign-in failed</strong><br>
        <span class="small muted" id="auth-error-msg"></span>
      </div>
    </div>
    {% endif %}

    {% if tunnel.enabled %}
    <section class="section-title">Secure Tunnel</section>
    <div class="tunnel-card {{ 'tunnel-card--ok' if tunnel.healthy else ('tunnel-card--warn' if tunnel.running else 'tunnel-card--err') }}" id="tunnel-card">
      <div class="tunnel-card__header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/>
        </svg>
        <span>Cloudflare Tunnel</span>
        <span class="access-status {{ 'access-status--ok' if tunnel.healthy else ('access-status--neutral' if tunnel.running else 'access-status--err') }}" id="tunnel-status">
          {% if tunnel.healthy %}✓ Connected{% elif tunnel.running %}⟳ Connecting{% else %}✕ Disconnected{% endif %}
        </span>
      </div>
      <div class="tunnel-card__body">
        <div id="tunnel-quick-url-row" {% if tunnel.mode != 'quick' or not tunnel.url %}style="display:none"{% endif %} class="access-row">
          <span class="access-label">URL</span>
          <a href="{{ tunnel.url or '#' }}" target="_blank" rel="noopener" class="access-link" id="tunnel-url">{{ tunnel.url or '' }}</a>
        </div>
        <div id="tunnel-static-info" {% if tunnel.mode != 'static' or not logged_in %}style="display:none"{% endif %}>
        <div class="access-row">
          <span class="access-label">Hostname</span>
          <span class="access-value mono" id="tunnel-hostname">{{ tunnel.hostname or '\u2014' }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">URL</span>
          <a href="{{ tunnel.url or '#' }}" target="_blank" rel="noopener" class="access-link" id="tunnel-static-url">{{ tunnel.url or '' }}</a>
        </div>
        </div>
        {% if tunnel.fallback_url %}
        <div class="access-row" id="tunnel-fallback-row">
          <span class="access-label">Temp URL <span class="pill pill--gray" style="font-size:.65rem;padding:.1rem .4rem">now</span></span>
          <a href="{{ tunnel.fallback_url }}" target="_blank" rel="noopener" class="access-link" id="tunnel-fallback-url">{{ tunnel.fallback_url }}</a>
        </div>
        {% elif tunnel.mode == 'static' %}
        <div class="access-row" id="tunnel-fallback-row" style="display:none">
          <span class="access-label">Temp URL <span class="pill pill--gray" style="font-size:.65rem;padding:.1rem .4rem">now</span></span>
          <a href="#" target="_blank" rel="noopener" class="access-link" id="tunnel-fallback-url"></a>
        </div>
        {% endif %}
        <div class="access-row">
          <span class="access-label">Unique ID</span>
          <span class="access-value mono" id="tunnel-uid">{{ tunnel.unique_id or '—' }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">Provider</span>
          <span class="access-value">Cloudflare {{ '(Static)' if tunnel.mode == 'static' else '(Quick — URL resets on restart)' }}</span>
        </div>
        {% if tunnel.error %}
        <div class="tunnel-error">
          <svg width="15" height="15" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;margin-top:.1rem">
            <path d="M10 2L2 17h16L10 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            <path d="M10 8v4M10 14v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>{{ tunnel.error }}</span>
        </div>
        {% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--ok" id="tunnel-hint-ok" {% if not tunnel.healthy %}style="display:none"{% endif %}>
        Accessible from anywhere — no port forwarding required.{% if tunnel.mode == 'quick' %}<br><span class="small muted">Quick Tunnel URL changes on add-on restart.</span>{% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--warn" id="tunnel-hint-warn" {% if tunnel.healthy or not tunnel.running %}style="display:none"{% endif %}>
        Tunnel is connecting. This usually takes a few seconds.{% if tunnel.fallback_url %} Use the <strong>Temp URL</strong> above in the meantime.{% endif %}
      </div>
      <div class="tunnel-card__hint tunnel-card__hint--err" id="tunnel-hint-err" {% if tunnel.healthy or tunnel.running %}style="display:none"{% endif %}>
        Tunnel is not running. Check the add-on logs.{% if tunnel.fallback_url %} Use the <strong>Temp URL</strong> above in the meantime.{% endif %}
      </div>
    </div>
    {% endif %}

    <section class="section-title">Access</section>
    <div class="access-grid">

      <div class="access-card {{ 'access-card--ok' if access.local.reachable else 'access-card--warn' }}">
        <div class="access-card__header">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>Local Network</span>
          <span class="access-status {{ 'access-status--ok' if access.local.reachable else 'access-status--err' }}" id="local-status">
            {{ '✓ Reachable' if access.local.reachable else '✕ Not Reachable' }}
          </span>
        </div>
        <div class="access-card__body">
          <div class="access-row">
            <span class="access-label">LAN IP</span>
            <span class="access-value mono" id="local-ip">{{ access.local.ip or '—' }}</span>
          </div>
          <div class="access-row">
            <span class="access-label">Port</span>
            <span class="access-value mono">{{ access.local.port }} (HTTPS)</span>
          </div>
          {% if access.local.url %}
          <div class="access-row">
            <span class="access-label">URL</span>
            <a href="{{ access.local.url }}" target="_blank" rel="noopener" class="access-link" id="local-url">{{ access.local.url }}</a>
          </div>
          {% endif %}
        </div>
        {% if not access.local.reachable %}
        <div class="access-card__hint">
          Port {{ access.local.port }} is not responding. Check that Caddy is running. Use <strong>https://</strong> (not http).
        </div>
        {% else %}
        <div class="access-card__hint access-card__hint--info">
          Use <strong>https://</strong> — plain http will show &ldquo;Bad Request&rdquo;. Self-signed cert: click <em>Advanced → Proceed</em>.
        </div>
        {% endif %}
      </div>

      <div class="access-card {{ 'access-card--ok' if access.external.reachable else ('access-card--warn' if access.external.configured else 'access-card--info') }}">
        <div class="access-card__header">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M2 12h20M12 2a15.3 15.3 0 010 20M12 2a15.3 15.3 0 000 20" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>Remote Access</span>
          {% if not access.external.configured %}
          <span class="access-status access-status--neutral">No Public IP</span>
          {% elif access.external.reachable %}
          <span class="access-status access-status--ok" id="ext-status">✓ Reachable</span>
          {% else %}
          <span class="access-status access-status--err" id="ext-status">✕ Not Reachable</span>
          {% endif %}
        </div>
        <div class="access-card__body">
          {% if access.external.mode == 'domain' %}
          <div class="access-row">
            <span class="access-label">Domain</span>
            <span class="access-value mono" id="ext-domain">{{ access.external.domain }}</span>
          </div>
          {% endif %}
          <div class="access-row">
            <span class="access-label">Public IP</span>
            <span class="access-value mono" id="ext-ip">{{ access.external.public_ip or 'Detecting…' }}</span>
          </div>
          <div class="access-row">
            <span class="access-label">Port</span>
            <span class="access-value mono">{{ access.external.port }} (HTTPS)</span>
          </div>
          {% if access.external.url %}
          <div class="access-row">
            <span class="access-label">URL</span>
            <a href="{{ access.external.url }}" target="_blank" rel="noopener" class="access-link" id="ext-url">{{ access.external.url }}</a>
          </div>
          {% endif %}
        </div>
        {% if not access.external.configured %}
        <div class="access-card__hint">
          Could not determine public IP. Check internet connectivity.
        </div>
        {% elif access.external.mode == 'ip' and not access.external.reachable %}
        <div class="access-card__hint">
          Port <strong>{{ access.external.port }}</strong> is not yet forwarded on your router.<br>
          <strong>One-time setup:</strong> In your router admin, create a port-forward rule:<br>
          &nbsp;&nbsp;External port <strong>{{ access.external.port }}</strong> TCP &rarr; internal <strong>{{ access.local.ip or '(see LAN IP)' }}:{{ access.external.port }}</strong><br>
          Then use <strong>https://{{ access.external.public_ip }}:{{ access.external.port }}</strong> from anywhere.<br>
          Self-signed cert &mdash; click <em>Advanced &rarr; Proceed</em> on first visit.
        </div>
        {% elif access.external.mode == 'ip' and access.external.reachable %}
        <div class="access-card__hint access-card__hint--info">
          Self-signed certificate. On first visit click <em>Advanced &rarr; Proceed</em> in your browser.
        </div>
        {% elif access.external.mode == 'domain' and not access.external.reachable %}
        <div class="access-card__hint">
          Port {{ access.external.port }} on your domain is not serving Vipsy. Check router port-forwarding and DNS.
        </div>
        {% endif %}
      </div>

    </div>

    <section class="section-title">Local VPN <span class="small muted" style="font-weight:400;font-size:.75rem">(same network — requires port forwarding for remote)</span></section>
    <div class="vpn-card {{ 'vpn-card--ok' if vpn.enabled else 'vpn-card--off' }}" id="vpn-card">
      <div class="vpn-card__header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
        <span>WireGuard VPN</span>
        <span class="access-status {{ 'access-status--ok' if vpn.enabled else 'access-status--neutral' }}" id="vpn-status">
          {% if vpn.enabled %}✓ Active{% else %}○ Inactive{% endif %}
        </span>
      </div>
      <div class="vpn-card__body">
        <div class="vpn-controls">
          {% if vpn.enabled %}
          <button class="btn btn--sm btn--red" id="vpn-disable-btn" onclick="vpnDisable()">Disable VPN</button>
          {% else %}
          <button class="btn btn--sm btn--green" id="vpn-enable-btn" onclick="vpnEnable()">Enable VPN</button>
          {% endif %}
          {% if vpn.enabled %}
          <button class="btn btn--sm btn--danger" id="vpn-kill-btn" onclick="vpnKill()" title="Remove all peers and shut down VPN immediately">Kill Switch</button>
          {% endif %}
        </div>
        {% if vpn.enabled %}
        <div class="access-row">
          <span class="access-label">Subnet</span>
          <span class="access-value mono">{{ vpn.subnet }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">Port</span>
          <span class="access-value mono">{{ vpn.port }}/udp</span>
        </div>
        <div class="access-row">
          <span class="access-label">Server IP</span>
          <span class="access-value mono">{{ vpn.server_ip }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">LAN Subnet</span>
          <span class="access-value mono">{{ vpn.lan_subnet }}</span>
        </div>
        <div class="access-row">
          <span class="access-label">Peers</span>
          <span class="access-value" id="vpn-peer-count">{{ vpn.peer_count }} total, {{ vpn.connected_count }} connected</span>
        </div>
        {% if vpn.overlap_warning %}
        <div class="vpn-warning">⚠ {{ vpn.overlap_warning }}</div>
        {% endif %}
        {% endif %}
      </div>
      {% if vpn.enabled %}
      <div class="vpn-card__hint vpn-card__hint--ok">
        VPN is active — peers can access your LAN via split-tunnel.
      </div>
      {% else %}
      <div class="vpn-card__hint vpn-card__hint--neutral">
        VPN is disabled. Enable it to allow peers to join your LAN securely.
      </div>
      {% endif %}
    </div>

    {% if vpn.enabled %}
    <div class="vpn-peers-section">
      <div class="vpn-peers-header">
        <span class="section-title" style="margin:0">Peers</span>
        <button class="btn btn--sm btn--blue" id="vpn-add-peer-toggle" onclick="toggleAddPeer()">+ Add Peer</button>
      </div>

      <div class="card vpn-add-form" id="vpn-add-form" style="display:none">
        <div class="form-group">
          <label for="peer-name">Name</label>
          <input type="text" id="peer-name" placeholder="e.g. Phone, Laptop" maxlength="64" class="form-input">
        </div>
        <div class="form-group">
          <label for="peer-ttl">Expires in (hours, 0 = never)</label>
          <input type="number" id="peer-ttl" value="0" min="0" max="8760" class="form-input">
        </div>
        <div class="form-group form-check">
          <input type="checkbox" id="peer-persistent">
          <label for="peer-persistent">Persistent (survives restarts even if expired)</label>
        </div>
        <button class="btn btn--blue" id="vpn-add-peer-btn" onclick="vpnAddPeer()">Create Peer</button>
      </div>

      <div id="vpn-peer-result" style="display:none" class="card vpn-peer-result">
        <div class="vpn-peer-result__header">
          <strong>Peer created</strong>
          <button class="btn btn--sm" onclick="document.getElementById('vpn-peer-result').style.display='none'">✕</button>
        </div>
        <div class="form-group">
          <label>LAN Config <span class="muted small">(same network)</span></label>
          <pre class="setup-code" id="vpn-peer-config-text" style="max-height:180px;overflow:auto"></pre>
        </div>
        <div class="vpn-peer-actions">
          <button class="btn btn--sm btn--blue" onclick="copyPeerConfig()">Copy LAN Config</button>
          <a class="btn btn--sm" id="vpn-peer-dl-link" href="#" download>⬇ LAN .conf</a>
          <a class="btn btn--sm" id="vpn-peer-qr-link" href="#" target="_blank">QR</a>
        </div>
        <div id="vpn-peer-qr-img" style="text-align:center;margin-top:.5rem"></div>
        <div id="vpn-remote-block" style="display:none;margin-top:.75rem;border-top:1px solid var(--border);padding-top:.75rem">
          <div class="form-group">
            <label>Remote Config <span class="muted small">(outside network — requires port forwarding)</span></label>
            <pre class="setup-code" id="vpn-peer-remote-config-text" style="max-height:180px;overflow:auto"></pre>
          </div>
          <div class="vpn-peer-actions">
            <a class="btn btn--sm" id="vpn-peer-dl-remote" href="#" download>⬇ Remote .conf</a>
            <a class="btn btn--sm" id="vpn-peer-qr-remote" href="#" target="_blank">QR</a>
          </div>
        </div>
      </div>

      <div id="vpn-peers-list">
        {% if vpn_peers %}
        <table class="vpn-peers-table">
          <thead>
            <tr><th>Name</th><th>IP</th><th>Status</th><th>Expires</th><th></th></tr>
          </thead>
          <tbody id="vpn-peers-tbody">
            {% for p in vpn_peers %}
            <tr id="peer-row-{{ p.peer_id }}">
              <td>{{ p.name }}</td>
              <td class="mono">{{ p.vpn_ip }}</td>
              <td>
                <span class="dot dot--{{ 'green' if p.connected else 'gray' }}"></span>
                {{ 'Connected' if p.connected else 'Idle' }}
              </td>
              <td class="mono small">{{ p.expires_at[:16] if p.expires_at else 'Never' }}</td>
              <td>
                <a href="{{ ingress_entry }}/api/vpn/peers/{{ p.peer_id }}/config?network=lan" class="btn btn--sm" title="LAN config">⬇ LAN</a>
                <a href="{{ ingress_entry }}/api/vpn/peers/{{ p.peer_id }}/config?network=remote" class="btn btn--sm" title="Remote config">⬇ WAN</a>
                <a href="{{ ingress_entry }}/api/vpn/peers/{{ p.peer_id }}/qr?network=lan" class="btn btn--sm" target="_blank" title="LAN QR">◻</a>
                <button class="btn btn--sm btn--red" onclick="vpnRemovePeer('{{ p.peer_id }}')" title="Remove peer">✕</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="card muted small" id="vpn-no-peers" style="text-align:center;padding:1.5rem">No peers yet. Click <strong>+ Add Peer</strong> to create one.</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <section class="section-title">Remote Access VPN <span class="small muted" style="font-weight:400;font-size:.75rem">(no port forwarding needed)</span></section>
    {% if not backend_available %}
    <div class="card card--setup">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#b45309">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div class="small muted">Remote access requires a connected backend. Sign in to get started.</div>
    </div>
    {% else %}
    <div class="vpn-card {{ 'vpn-card--ok' if hub.connected else 'vpn-card--off' }}" id="hub-card">
      <div class="vpn-card__header">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M12 2a14.5 14.5 0 0 0 0 20M12 2a14.5 14.5 0 0 1 0 20M2 12h20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>Remote Access</span>
        <span class="access-status {{ 'access-status--ok' if hub.connected else 'access-status--neutral' }}" id="hub-status-badge">
          {% if hub.connected %}✓ Connected{% else %}○ Off{% endif %}
        </span>
      </div>
      <div class="vpn-card__body">
        <div class="vpn-controls">
          {% if not hub.connected %}
          <button class="btn btn--sm btn--green" id="hub-enable-btn" onclick="hubEnable()">Enable Remote Access</button>
          {% else %}
          <button class="btn btn--sm btn--red" id="hub-disable-btn" onclick="hubDisable()">Disable Remote Access</button>
          {% endif %}
        </div>
        {% if hub.connected %}
        <div class="access-row">
          <span class="access-label">Your VPN IP</span>
          <span class="access-value mono">{{ hub.vpn_ip }}</span>
        </div>
        {% if hub.lan_subnet %}
        <div class="access-row">
          <span class="access-label">LAN Subnet</span>
          <span class="access-value mono">{{ hub.lan_subnet }}</span>
        </div>
        {% endif %}
        <div class="access-row">
          <span class="access-label">Peer Devices</span>
          <span class="access-value" id="hub-peer-count">{{ hub.peer_count }}</span>
        </div>
        {% endif %}
      </div>
      {% if hub.connected %}
      <div class="vpn-card__hint vpn-card__hint--ok">Remote access is active. Add devices below to connect from anywhere.</div>
      {% else %}
      <div class="vpn-card__hint vpn-card__hint--neutral">Enable remote access to let your devices securely reach your home network from anywhere — no port forwarding required.</div>
      {% endif %}
    </div>

    {% if hub.connected %}
    <div class="vpn-peers-section">
      <div class="vpn-peers-header">
        <span class="section-title" style="margin:0">Remote Devices</span>
        <button class="btn btn--sm btn--blue" id="hub-add-peer-toggle" onclick="toggleHubAddPeer()">+ Add Device</button>
      </div>

      <div class="card vpn-add-form" id="hub-add-form" style="display:none">
        <div class="form-group">
          <label for="hub-peer-name">Device name</label>
          <input type="text" id="hub-peer-name" placeholder="e.g. Phone, Laptop" maxlength="64" class="form-input">
        </div>
        <button class="btn btn--blue" id="hub-add-peer-btn" onclick="hubAddPeer()">Create Device</button>
      </div>

      <div id="hub-peer-result" style="display:none" class="card vpn-peer-result">
        <div class="vpn-peer-result__header">
          <strong>Device added</strong>
          <button class="btn btn--sm" onclick="document.getElementById('hub-peer-result').style.display='none'">✕</button>
        </div>
        <div class="form-group">
          <label>WireGuard Config</label>
          <pre class="setup-code" id="hub-peer-config-text" style="max-height:200px;overflow:auto"></pre>
        </div>
        <div class="vpn-peer-actions">
          <button class="btn btn--sm btn--blue" onclick="copyHubPeerConfig()">Copy Config</button>
          <a class="btn btn--sm" id="hub-peer-dl-link" href="#" download>⬇ Download .conf</a>
          <a class="btn btn--sm" id="hub-peer-qr-link" href="#" target="_blank">QR Code</a>
        </div>
        <div id="hub-peer-qr-img" style="text-align:center;margin-top:.5rem"></div>
      </div>

      <div id="hub-peers-list">
        <div class="card muted small" id="hub-no-peers" style="text-align:center;padding:1.5rem;display:none">No devices yet. Click <strong>+ Add Device</strong> to create one.</div>
        <table class="vpn-peers-table" id="hub-peers-table" style="{{ 'display:none' if not hub.connected else '' }}">
          <thead>
            <tr><th>Device</th><th>IP</th><th></th></tr>
          </thead>
          <tbody id="hub-peers-tbody"></tbody>
        </table>
      </div>
    </div>
    {% endif %}
    {% endif %}

    <section class="section-title">Home Assistant Core</section>
    <div class="card stat-row">
      <span class="stat-label">HA Core (:8123)</span>
      <span class="{{ 'chip chip--green' if access.ha_core.reachable else 'chip chip--red' }}" id="ha-status">
        <span class="dot dot--{{ 'green' if access.ha_core.reachable else 'red' }}"></span>
        {{ 'Reachable' if access.ha_core.reachable else 'Not Reachable' }}
      </span>
    </div>
    {% if access.ha_core.reachable and not access.ha_core.proxy_ok %}
    <div class="card card--setup">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink:0;color:#b45309">
        <path d="M10 2L2 17h16L10 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M10 8v4M10 14v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <div>
        <strong>One-time HA setup needed</strong><br>
        <span class="small muted">Add this to your <code>configuration.yaml</code> then restart HA Core:</span>
        <pre class="setup-code">http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.30.33.0/24
    - 127.0.0.1</pre>
      </div>
    </div>
    {% endif %}

    <section class="section-title">Services</section>
    <div class="card">
      <table>
        <thead>
          <tr><th>Service</th><th>Status</th><th>Role</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Caddy</td>
            <td><span class="dot dot--{{ 'green' if caddy_up else 'red' }}"></span>{{ 'Up' if caddy_up else 'Down' }}</td>
            <td class="muted">TLS termination + reverse proxy</td>
          </tr>
          {% if enable_turn %}
          <tr>
            <td>coturn</td>
            <td><span class="dot dot--{{ 'green' if turn_up else 'red' }}"></span>{{ 'Up' if turn_up else 'Down' }}</td>
            <td class="muted">TURN/STUN relay (WebRTC)</td>
          </tr>
          {% endif %}
          {% if tunnel.enabled %}
          <tr>
            <td>cloudflared</td>
            <td><span class="dot dot--{{ 'green' if tunnel.running else 'red' }}"></span>{{ 'Up' if tunnel.running else 'Down' }}</td>
            <td class="muted">Cloudflare Tunnel connector</td>
          </tr>
          {% endif %}
          <tr>
            <td>WireGuard</td>
            <td><span class="dot dot--{{ 'green' if vpn.enabled else 'gray' }}"></span>{{ 'Up' if vpn.enabled else 'Off' }}</td>
            <td class="muted">Local VPN gateway ({{ vpn.peer_count }} peers)</td>
          </tr>
          <tr>
            <td>Remote Access</td>
            <td><span class="dot dot--{{ 'green' if hub.connected else 'gray' }}"></span>{{ 'Up' if hub.connected else 'Off' }}</td>
            <td class="muted">Remote VPN ({{ hub.peer_count }} devices)</td>
          </tr>
          <tr>
            <td>TLS Certificate</td>
            <td colspan="2" class="mono small">{{ cert_status }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <section class="card card--notice">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="flex-shrink:0">
        <circle cx="10" cy="10" r="9" stroke="#6b7280" stroke-width="2"/>
        <path d="M10 6v5M10 13v1" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <p>This add-on proxies only Home Assistant. Remote Access VPN lets your devices securely reach your home LAN from anywhere. Local VPN provides split-tunnel LAN access on the same network.</p>
    </section>

    <footer>
      <span>Vipsy v{{ version }}</span>
      <span id="last-refresh">{{ now }}</span>
    </footer>

  </div>
  <script>
    var INGRESS_ENTRY = "{{ ingress_entry }}";
    var BACKEND_AVAILABLE = {{ 'true' if backend_available else 'false' }};
    var LOGGED_IN = {{ 'true' if logged_in else 'false' }};
    var BACKEND_URL = "{{ backend_url }}";
    var INSTANCE_ID = "{{ instance_id }}";
    var _basePath = (INGRESS_ENTRY || "").replace(/\/$/, "") + "/";
    function _esc(s){var d=document.createElement("div");d.appendChild(document.createTextNode(s||""));return d.innerHTML;}
    window.toggleHubAddPeer = function(){var f=document.getElementById("hub-add-form");if(f)f.style.display=f.style.display==="none"?"":"none";};
    window.hubAddPeer = function(){
      var name=(document.getElementById("hub-peer-name")||{}).value||"";
      if(!name.trim()){alert("Device name is required");return;}
      var btn=document.getElementById("hub-add-peer-btn");if(btn)btn.disabled=true;
      fetch(_basePath+"api/hub/peers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:name.trim()})})
        .then(function(r){return r.json();}).then(function(d){
          if(btn)btn.disabled=false;if(!d.ok){alert(d.error||"Failed to add device");return;}
          document.getElementById("hub-add-form").style.display="none";
          var result=document.getElementById("hub-peer-result");if(result)result.style.display="";
          var cfg=document.getElementById("hub-peer-config-text");if(cfg)cfg.textContent=d.config||"";
          var dl=document.getElementById("hub-peer-dl-link");if(dl&&d.peer){dl.href=_basePath+"api/hub/peers/"+d.peer.peer_id+"/config";dl.download="vipsy-remote-"+d.peer.peer_id+".conf";}
          var qrl=document.getElementById("hub-peer-qr-link");if(qrl&&d.peer)qrl.href=_basePath+"api/hub/peers/"+d.peer.peer_id+"/qr";
          var qri=document.getElementById("hub-peer-qr-img");if(qri&&d.peer)qri.innerHTML='<img src="'+_basePath+"api/hub/peers/"+d.peer.peer_id+'/qr" alt="QR" style="max-width:220px;margin-top:.5rem">';
          if(window.refreshHubPeers)refreshHubPeers();
        }).catch(function(){if(btn)btn.disabled=false;alert("Network error");});
    };
    window.hubEnable = function(){
      var btn=document.getElementById("hub-enable-btn");if(btn){btn.disabled=true;btn.textContent="Connecting\u2026";}
      fetch(_basePath+"api/hub/enable",{method:"POST"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok)location.reload();else{alert(d.error||"Failed to enable");if(btn){btn.disabled=false;btn.textContent="Enable Remote Access";}}
      }).catch(function(){alert("Network error");if(btn){btn.disabled=false;btn.textContent="Enable Remote Access";}});
    };
    window.hubDisable = function(){
      if(!confirm("Disable remote access?"))return;
      fetch(_basePath+"api/hub/disable",{method:"POST"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok)location.reload();else alert(d.error||"Disconnect failed");
      }).catch(function(){alert("Network error");});
    };
    window.hubRemovePeer = function(id){
      if(!confirm("Remove this device?"))return;
      fetch(_basePath+"api/hub/peers/"+id,{method:"DELETE"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok){var r=document.getElementById("hub-peer-row-"+id);if(r)r.remove();if(window.refreshHubPeers)refreshHubPeers();}
        else alert(d.error||"Failed to remove");
      }).catch(function(){alert("Network error");});
    };
    window.copyHubPeerConfig = function(){
      var el=document.getElementById("hub-peer-config-text");
      if(el)navigator.clipboard.writeText(el.textContent).then(function(){alert("Copied!");}).catch(function(){});
    };
    window.toggleAddPeer = function(){var f=document.getElementById("vpn-add-form");if(f)f.style.display=f.style.display==="none"?"":"none";};
    window.vpnEnable = function(){
      fetch(_basePath+"api/vpn/enable",{method:"POST"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok)location.reload();else alert(d.error||"Failed");
      }).catch(function(){alert("Network error");});
    };
    window.vpnDisable = function(){
      if(!confirm("Disable VPN?"))return;
      fetch(_basePath+"api/vpn/disable",{method:"POST"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok)location.reload();else alert(d.error||"Failed");
      }).catch(function(){alert("Network error");});
    };
    window.vpnKill = function(){
      if(!confirm("KILL VPN?"))return;
      fetch(_basePath+"api/vpn/kill",{method:"POST"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok)location.reload();else alert(d.error||"Failed");
      }).catch(function(){alert("Network error");});
    };
    window.vpnAddPeer = function(){
      var name=(document.getElementById("peer-name")||{}).value||"";
      var ttlH=parseFloat((document.getElementById("peer-ttl")||{}).value||"0");
      var persistent=(document.getElementById("peer-persistent")||{}).checked||false;
      if(!name.trim()){alert("Peer name is required");return;}
      var ttl=ttlH>0?Math.round(ttlH*3600):null;var body={name:name.trim(),persistent:persistent};if(ttl)body.ttl=ttl;
      fetch(_basePath+"api/vpn/peers",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)})
        .then(function(r){return r.json();}).then(function(d){
          if(!d.ok){alert(d.error||"Failed");return;}
          document.getElementById("vpn-add-form").style.display="none";
          var result=document.getElementById("vpn-peer-result");if(result)result.style.display="";
          var cfg=document.getElementById("vpn-peer-config-text");if(cfg)cfg.textContent=d.config||"";
          var dl=document.getElementById("vpn-peer-dl-link");if(dl&&d.peer)dl.href=_basePath+"api/vpn/peers/"+d.peer.peer_id+"/config?network=lan";
          var qrl=document.getElementById("vpn-peer-qr-link");if(qrl&&d.peer)qrl.href=_basePath+"api/vpn/peers/"+d.peer.peer_id+"/qr?network=lan";
          if(window.refreshVpnPeers)refreshVpnPeers();
        }).catch(function(){alert("Network error");});
    };
    window.vpnRemovePeer = function(id){
      if(!confirm("Remove this peer?"))return;
      fetch(_basePath+"api/vpn/peers/"+id,{method:"DELETE"}).then(function(r){return r.json();}).then(function(d){
        if(d.ok){var r=document.getElementById("peer-row-"+id);if(r)r.remove();if(window.refreshVpnPeers)refreshVpnPeers();}
        else alert(d.error||"Failed");
      }).catch(function(){alert("Network error");});
    };
    window.copyPeerConfig = function(){
      var el=document.getElementById("vpn-peer-config-text");
      if(el)navigator.clipboard.writeText(el.textContent).then(function(){alert("Copied!");}).catch(function(){});
    };
  </script>
  <script src="{{ ingress_entry }}/static/app.js?v={{ version }}"></script>
</body>
</html>
